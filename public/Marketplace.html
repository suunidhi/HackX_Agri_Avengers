<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Marketplace - AgriDirect</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      display: flex;
      flex-direction: column;
      font-family: 'Segoe UI', sans-serif;
      background: #f8f9fa;
    }
    main { flex: 1; }
    h1 { text-align: center; margin: 30px 0; font-weight: bold; color: #2d6a4f; }
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }
    .card-container { perspective: 1000px; }
    .product-card {
      width: 100%;
      height: 500px;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.8s;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      background: #fff;
    }
    .product-card.is-flipped { transform: rotateY(180deg); }
    .card-side {
      width: 100%;
      height: 100%;
      position: absolute;
      backface-visibility: hidden;
      border-radius: 12px;
      background: #fff;
      padding: 15px;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
    }
    .card-front img {
      width: 100%;
      height: 220px;
      object-fit: cover;
      border-radius: 10px;
      margin-bottom: 10px;
    }
    .card-back {
      transform: rotateY(180deg);
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      text-align: center;
    }
    .product-info { flex: 1; }
    .product-info h5 { font-size: 18px; margin-bottom: 5px; color: #1b4332; }
    .product-info p { margin: 0; font-size: 14px; color: #495057; }
    .price { font-size: 18px; color: #d00000; font-weight: bold; margin: 5px 0; }
    .btn-buy {
      margin-top: auto;
      width: 48%;
      background: #2d6a4f;
      color: white;
      border-radius: 8px;
      border: none;
      padding: 10px;
      font-size: 15px;
      transition: background 0.3s;
    }
    .btn-buy:hover { background: #1b4332; }
    .btn-sqr {
      margin-top: auto;
      width: 48%;
      background: #e2c106;
      color: #fff;
      border-radius: 8px;
      border: none;
      padding: 10px;
      font-size: 15px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .btn-sqr:hover { background: #ec8404; }
    .btn-group { display: flex; justify-content: space-between; margin-top: 10px; }
    .qr { margin-top: 15px; width: 150px; height: 150px; }

    nav { display: flex; justify-content: space-between; align-items: center; background:#5D8736; padding: 15px 30px; font-size: larger; }
    .logo { display: flex; align-items: center; }
    .logo video { width: 50px; height: 50px; margin-right: 10px; border-radius: 5px; }
    .logo-text { font-size: 24px; font-weight: bold; color:#ffffff; }
    nav ul { list-style: none; display: flex; }
    nav ul li { margin: 0 15px; padding: 7px; }
    nav ul li a { text-decoration: none; color: #ffffff; font-weight: bold; }
    nav ul li a:hover { color:#F4FFC3; }

    footer {
      background:white;
      color:#809D3C;
      padding: 30px 20px;
      text-align: center;
      border-top: 2px solid #5D8736;
    }
    .footer-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      max-width: 1200px;
      margin: auto;
    }
    .footer-logo {
      display: flex;
      align-items: center;
      font-size: 22px;
      font-weight: bold;
    }
    .footer-logo video {
      width: 50px;
      height: 50px;
      margin-right: 10px;
      border-radius: 5px;
    }
    .footer-social a img {
      width: 30px;
      margin: 0 10px;
      transition: transform 0.3s ease-in-out;
    }
    .footer-social a img:hover { transform: scale(1.2); }
    .footer-copy { margin-top: 15px; font-size: 14px; opacity: 0.8; }
    /* üåæ Filter Container Styling */
.filter-container {
  background: #eaf4e0;
  border: 2px solid #5D8736;
  border-radius: 10px;
  padding: 12px 20px;
  margin: 20px auto 30px auto;
  width: 90%;
  max-width: 400px;
  display: flex;
  justify-content: center;
  align-items: center;
  box-shadow: 0 4px 8px rgba(93, 135, 54, 0.2);
  transition: all 0.3s ease-in-out;
}

.filter-container:hover {
  transform: scale(1.02);
  box-shadow: 0 6px 12px rgba(93, 135, 54, 0.3);
}

/* Dropdown styling */
#preferenceFilter {
  padding: 10px 15px;
  border: 2px solid #5D8736;
  border-radius: 8px;
  background-color: #ffffff;
  font-size: 16px;
  font-weight: 500;
  color: #2d6a4f;
  outline: none;
  cursor: pointer;
  transition: border-color 0.3s, box-shadow 0.3s;
}

#preferenceFilter:hover {
  border-color: #3e7b27;
  box-shadow: 0 0 6px rgba(46, 125, 50, 0.3);
}

#preferenceFilter:focus {
  border-color: #1b4332;
  box-shadow: 0 0 8px rgba(27, 67, 50, 0.4);
}

/* Label styling */
.filter-container label {
  font-size: 16px;
  color: #1b4332;
  font-weight: 600;
  margin-right: 10px;
}

  </style>
</head>
<body>

  <header>
    <nav>
      <div class="logo">
        <video autoplay loop muted>
          <source src="image/agridirect.mp4" type="video/mp4">
        </video>
        <span class="logo-text">AgriDirect</span>
      </div>
      <ul>
        <li><a href="shared_homepage.html">HOME</a></li>
        <li><a href="marketplace.html">MARKETPLACE</a></li>
        <li><a id="dashboardLink" href="#">DASHBOARD</a></li>
        <li><a href="about_us.html">ABOUT US</a></li>
        <li><a id="authLink" href="role.html">LOGIN/SIGN UP</a></li>
      </ul>
    </nav>
  </header>

<main>
  <marquee behavior="scroll" direction="left" scrollamount="8" style="background:#F4FFC3; color:#2d6a4f; font-size:20px; font-weight:bold; padding:10px; border-bottom:2px solid #5D8736;">
    üå± Welcome to AgriDirect ‚Äî Bringing Farmers and Consumers Together! üå±
  </marquee>

  <div class="filter-container">
    <label for="preferenceFilter" style="font-weight:bold; margin-right:10px;">Filter by Preferences:</label>
    <select id="preferenceFilter">
      <option value="">All</option>
      <option value="jain">ü™î Jain</option>
      <option value="swaminarayan">üôè Swaminarayan</option>
      <option value="vegan">üå± Vegan</option>
      <option value="organic">üçÉ Organic</option>
      <option value="fruitarian">üçâ Fruitarian</option>
      <option value="gluten-free">üö´ Gluten-Free</option>
    </select>
  </div>

  <div class="container">
    <div class="product-grid" id="productGrid"></div>
  </div>
</main>

<footer>
  <div class="footer-container">
    <div class="footer-logo">
      <video autoplay loop muted playsinline>
        <source src="image/logo.mp4" type="video/mp4">
      </video>
      <span>AgriDirect</span>
    </div>

    <div class="footer-contact">
      <h3>Contact Us</h3>
      <p>Email: support@agriDirect.com</p>
      <p>Phone: +91 10101 01010</p>
    </div>

    <div class="footer-social">
      <h3>Follow Us</h3>
      <a href="#"><img src="image/linkedin.png" alt="LinkedIn"></a>
      <a href="#"><img src="image/twitter.png" alt="Twitter"></a>
      <a href="#"><img src="image/instagram.png" alt="Instagram"></a>
      <a href="#"><img src="image/youtube.png" alt="YouTube"></a>
    </div>
  </div>  
  <p class="footer-copy">&copy; 2025 AgriDirect. All Rights Reserved.</p>
</footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
  async function loadProducts() {
    try {
      const res = await fetch("http://localhost:5000/products");
      const data = await res.json();

      if (data.status === "success") {
        const productGrid = document.getElementById("productGrid");
        productGrid.innerHTML = "";

        data.products.forEach(p => {
          const wrapper = document.createElement("div");
          wrapper.className = "card-container";

          const productData = encodeURIComponent(JSON.stringify(p));

          wrapper.innerHTML = `
            <div class="product-card">
              <div class="card-side card-front">
                <img src="http://localhost:5000${p.image}" alt="${p.name}">
                <div class="product-info">
                  <h5>${p.name}</h5>
                  <p><strong>Category:</strong> ${p.category}</p>
                  <p><strong>Farmer:</strong> ${p.farmerId?.name || "Unknown"}</p>
                  <p><strong>Location:</strong> ${p.location}</p>
                  <p><strong>Quantity:</strong> ${p.quantity} kg</p>
                  <p class="price"><strong>Price:</strong> ‚Çπ${p.price}</p>
                  <div class="btn-group">
                    <button class="btn-buy" onclick="event.stopPropagation(); redirectToCheckout('${p._id}', '${p.farmerId?._id}', '${p.name}', ${p.price})">üõí Buy Now</button>
                    <button class="btn-sqr" onclick="event.stopPropagation(); showQR(this, '${productData}')">Verify Farmer</button>
                  </div>
                </div>
              </div>
              <div class="card-side card-back">
                <h5>Scan QR to verify</h5>
                <div class="qr"></div>
                <button class="btn btn-outline-success mt-3" onclick="event.stopPropagation(); unflipCard(this)">Back</button>
              </div>
            </div>
          `;
          productGrid.appendChild(wrapper);

          wrapper.querySelector(".product-card").addEventListener("click", function(e) {
            if (!e.target.closest("button")) this.classList.toggle("is-flipped");
          });
        });

        // ‚úÖ Add "+ Add Product" card for farmers
        const userRole = localStorage.getItem("userRole");
        if (userRole === "farmer") {
          const addWrapper = document.createElement("div");
          addWrapper.className = "card-container";
          addWrapper.innerHTML = `
            <div class="product-card text-center d-flex flex-column justify-content-center align-items-center border border-success"
                style="cursor:pointer; height:500px; background:#f1fdf1; border-radius:12px;">
              <div>
                <h1 style="font-size:80px; color:#2d6a4f;">+</h1>
                <h4 style="color:#2d6a4f;">Add New Product</h4>
              </div>
            </div>
          `;
          addWrapper.addEventListener("click", () => {
            window.location.href = "farmeraddproduct.html";
          });
          productGrid.appendChild(addWrapper);
        }
      } else alert("Error loading products");
    } catch (err) {
      console.error(err);
      alert("Failed to fetch products from server");
    }
  }

  loadProducts();

  // ‚úÖ Buy logic
  function redirectToCheckout(productId, farmerId, name, price) {
    const consumerId = localStorage.getItem("consumerId");
    const isLoggedIn = consumerId && consumerId.trim() !== "";

    const checkoutData = { productId, farmerId, name, price };
    localStorage.setItem("checkoutProduct", JSON.stringify(checkoutData));

    if (!isLoggedIn) {
      alert("Please sign up or login before purchasing.");
      window.location.href = `consumer_signup18.html?productId=${encodeURIComponent(productId)}&farmerId=${encodeURIComponent(farmerId)}&name=${encodeURIComponent(name)}&price=${encodeURIComponent(price)}`;
    } else {
      window.location.href = `checkout.html?productId=${encodeURIComponent(productId)}&farmerId=${encodeURIComponent(farmerId)}&name=${encodeURIComponent(name)}&price=${encodeURIComponent(price)}`;
    }
  }

  // ‚úÖ QR logic
  function showQR(button, encodedProduct) {
    const product = JSON.parse(decodeURIComponent(encodedProduct));
    const card = button.closest(".product-card");
    card.classList.add("is-flipped");

    setTimeout(() => {
      const qrContainer = card.querySelector(".qr");
      qrContainer.innerHTML = "";

      if (product.qrPath) {
        const img = document.createElement("img");
        img.src = `http://localhost:5000${product.qrPath}`;
        img.alt = "Product QR Code";
        img.style.width = "150px";
        img.style.height = "150px";
        img.style.border = "2px dashed #2d6a4f";
        img.style.borderRadius = "10px";
        img.style.padding = "5px";
        img.style.background = "#fff";
        img.style.cursor = "pointer";
        img.onclick = () => window.open(img.src, "_blank");

        qrContainer.appendChild(img);
      } else {
        qrContainer.innerHTML = "<p class='text-danger'>QR not available</p>";
      }
    }, 400);
  }

  function unflipCard(button) {
    const card = button.closest(".product-card");
    card.classList.remove("is-flipped");
  }

  // ‚úÖ Navbar role-based logic
  document.addEventListener("DOMContentLoaded", () => {
    const dashboardLink = document.getElementById("dashboardLink");
    const authLink = document.getElementById("authLink");

    const userRole = localStorage.getItem("userRole");
    const consumerName = localStorage.getItem("consumerName");
    const farmerName = localStorage.getItem("farmerName");

    if (userRole === "farmer") {
      dashboardLink.href = "marketplacefarmer.html";
      authLink.textContent = `LOGOUT`;
      authLink.href = "#";
      authLink.onclick = () => {
        localStorage.clear();
        alert("Logged out successfully!");
        window.location.href = "shared_homepage.html";
      };
    } else if (userRole === "consumer") {
      dashboardLink.href = "consumer_dashboard.html";
      authLink.textContent = `LOGOUT `;
      authLink.href = "#";
      authLink.onclick = () => {
        localStorage.clear();
        alert("Logged out successfully!");
        window.location.href = "shared_homepage.html";
      };
    } else {
      dashboardLink.href = "role.html";
      authLink.textContent = "LOGIN/SIGN UP";
      authLink.href = "role.html";
    }
  });
// ‚úÖ FILTER PRODUCTS BY PREFERENCE (FINAL WORKING VERSION)
document.getElementById("preferenceFilter").addEventListener("change", async (e) => {
  const pref = e.target.value;
  let url = "http://localhost:5000/products";
  if (pref) url += `?preferences=${pref}`;

  try {
    const res = await fetch(url);
    const data = await res.json();

    const productGrid = document.getElementById("productGrid");
    productGrid.innerHTML = "";

    // ‚úÖ Check for success response
    if (data.status === "success" && Array.isArray(data.products)) {
      // ‚úÖ Case 1: No products found
      if (data.products.length === 0) {
        productGrid.innerHTML = `
          <div class="no-products" style="
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #555;
            font-family: 'Poppins', sans-serif;
            width: 100%;
          ">
            <h3 style="font-size: 1.8rem; color: #2d6a4f; margin-bottom: 10px;">
              No products found for this category üòî
            </h3>
            <p style="font-size: 1rem; color: #777;">
              Try changing your filters or check back later.
            </p>
          </div>
        `;

        // ‚úÖ Still show "+ Add Product" card if farmer logged in
        const userRole = localStorage.getItem("userRole");
        if (userRole === "farmer") {
          const addWrapper = document.createElement("div");
          addWrapper.className = "card-container";
          addWrapper.innerHTML = `
            <div class="product-card text-center d-flex flex-column justify-content-center align-items-center border border-success"
                style="cursor:pointer; height:500px; background:#f1fdf1; border-radius:12px;">
              <div>
                <h1 style="font-size:80px; color:#2d6a4f;">+</h1>
                <h4 style="color:#2d6a4f;">Add New Product</h4>
              </div>
            </div>
          `;
          addWrapper.addEventListener("click", () => {
            window.location.href = "farmeraddproduct.html";
          });
          productGrid.appendChild(addWrapper);
        }
        return;
      }

      // ‚úÖ Case 2: Render products normally
      data.products.forEach(p => {
        const wrapper = document.createElement("div");
        wrapper.className = "card-container";
        const productData = encodeURIComponent(JSON.stringify(p));

        wrapper.innerHTML = `
          <div class="product-card">
            <div class="card-side card-front">
              <img src="http://localhost:5000${p.image}" alt="${p.name}">
              <div class="product-info">
                <h5>${p.name}</h5>
                <p><strong>Category:</strong> ${p.category}</p>
                <p><strong>Farmer:</strong> ${p.farmerId?.name || "Unknown"}</p>
                <p><strong>Location:</strong> ${p.location}</p>
                <p><strong>Quantity:</strong> ${p.quantity} kg</p>
                <p class="price"><strong>Price:</strong> ‚Çπ${p.price}</p>
                <div class="btn-group">
                  <button class="btn-buy" onclick="event.stopPropagation(); redirectToCheckout('${p._id}', '${p.farmerId?._id}', '${p.name}', ${p.price})">üõí Buy Now</button>
                  <button class="btn-sqr" onclick="event.stopPropagation(); showQR(this, '${productData}')">Verify Farmer</button>
                </div>
              </div>
            </div>
            <div class="card-side card-back">
              <h5>Scan QR to verify</h5>
              <div class="qr"></div>
              <button class="btn btn-outline-success mt-3" onclick="event.stopPropagation(); unflipCard(this)">Back</button>
            </div>
          </div>
        `;
        productGrid.appendChild(wrapper);

        wrapper.querySelector(".product-card").addEventListener("click", function(e) {
          if (!e.target.closest("button")) this.classList.toggle("is-flipped");
        });
      });

      // ‚úÖ Add "+ Add Product" card last for farmers
      const userRole = localStorage.getItem("userRole");
      if (userRole === "farmer") {
        const addWrapper = document.createElement("div");
        addWrapper.className = "card-container";
        addWrapper.innerHTML = `
          <div class="product-card text-center d-flex flex-column justify-content-center align-items-center border border-success"
              style="cursor:pointer; height:500px; background:#f1fdf1; border-radius:12px;">
            <div>
              <h1 style="font-size:80px; color:#2d6a4f;">+</h1>
              <h4 style="color:#2d6a4f;">Add New Product</h4>
            </div>
          </div>
        `;
        addWrapper.addEventListener("click", () => {
          window.location.href = "farmeraddproduct.html";
        });
        productGrid.appendChild(addWrapper);
      }
    } else {
      console.error("Unexpected response format:", data);
    }
  } catch (err) {
    console.error("Error filtering products:", err);
  }
});
  </script>
</body>
</html>
